  <html>
   <head>
       <link rel="Stylesheet" type="text/css" href="main.css" />
   </head>
   <body>
        <div class="default">
          <pre class="code">
<span class="Entities4">module</span> <span class="className">CodeRay</span>
  <span class="Entities4">module</span> <span class="className">Scanners</span>

<span class="Entities3">class</span> <span class="className">Ruby</span> <span class="Operators">&lt;</span> <span class="className">S</span>canner

  <span class="Special">RESERVED_WORDS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">end</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">in</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">begin</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">defined?</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ensure</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">redo</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">super</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">BEGIN</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">break</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">do</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">next</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rescue</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">then</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">END</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">case</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">else</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">for</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">retry</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">alias</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">return</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">undef</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">yield</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">DEF_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">MODULE_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">DEF_NEW_STATE</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">initial</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">DEF_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">def_expected</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">MODULE_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">module_expected</span><span class="Pars">)</span>

  <span class="Special">WORDS_ALLOWING_REGEXP</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span>
  <span class="Pars">]</span>
  <span class="Special">REGEXP_ALLOWED</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Logic">false</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">WORDS_ALLOWING_REGEXP</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>

  <span class="Special">PREDEFINED_CONSTANTS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">nil</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">true</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">false</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">self</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">DATA</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGV</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGF</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__FILE__</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__LINE__</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">IDENT_KIND</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">ident</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">RESERVED_WORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">reserved</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">PREDEFINED_CONSTANTS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">pre_constant</span><span class="Pars">)</span>

  <span class="Special">METHOD_NAME</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{IDENT}</span><span class="Regex"> [?!]? </span><span class="Regex">/</span><span class="RegexOptions">xo</span>
  <span class="Special">METHOD_NAME_EX</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">
</span><span class="Regex">   </span><span class="Entities">#{METHOD_NAME}</span><span class="Regex">  # common methods: split, foo=, empty?, gsub!
</span><span class="Regex">   | \*\*?         # multiplication and power
</span><span class="Regex">   | [-+~]@?       # plus, minus
</span><span class="Regex">   | [\/%&amp;|^`]     # division, modulo or format strings, &amp;and, |or, ^xor, `system`
</span><span class="Regex">   | \[\]=?        # array getter and setter
</span><span class="Regex">   | &lt;=?&gt;? | &gt;=?   # comparison, rocket operator
</span><span class="Regex">   | &lt;&lt; | &gt;&gt;       # append or shift left, shift right
</span><span class="Regex">   | ===?          # simple equality and case equality
</span><span class="Regex">  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">GLOBAL_VARIABLE</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \$ (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> | \d+ | [~&amp;+`'=\/,;_.&lt;&gt;!@0$?*&quot;:F\\] | -[a-zA-Z_0-9] ) </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DOUBLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> &quot;  [^&quot;\#\\]*  (?: (?: \#\{.*?\} | \#(?:$&quot;)?  | \\. ) [^&quot;\#\\]*  )* &quot;?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SINGLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> '  [^'\\]*    (?:                              \\.   [^'\\]*    )* '?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">STRING</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{SINGLEQ}</span><span class="Regex"> | </span><span class="Entities">#{DOUBLEQ}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SHELL</span>   <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> `  [^`\#\\]*  (?: (?: \#\{.*?\} | \#(?:$`)?  | \\. ) [^`\#\\]*  )* `?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">REGEXP</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \/ [^\/\#\\]* (?: (?: \#\{.*?\} | \#(?:$\/)? | \\. ) [^\/\#\\]* )* \/? </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">\d+(?:_\d+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>  <span class="Comment"># doesn't recognize 09 as octal error</span>
  <span class="Special">OCTAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0_?[0-7]+(?:_[0-7]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">HEXADECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0x[0-9A-Fa-f]+(?:_[0-9A-Fa-f]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">BINARY</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0b[01]+(?:_[01]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Special">EXPONENT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> [eE] [+-]? </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">FLOAT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> (?: </span><span class="Entities">#{EXPONENT}</span><span class="Regex"> | \. </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Entities">#{EXPONENT}</span><span class="Regex">? ) </span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">INTEGER</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Entities">#{OCTAL}</span><span class="Regex">|</span><span class="Entities">#{HEXADECIMAL}</span><span class="Regex">|</span><span class="Entities">#{BINARY}</span><span class="Regex">|</span><span class="Entities">#{DECIMAL}</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Entities2">def</span> <span class="funcName">reset</span>
    <span class="Keywords">super</span>
    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Logic">false</span>
  <span class="Keywords">end</span>

  <span class="Entities2">def</span> <span class="funcName">next_token</span>
    <span class="Keywords">return</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>eos<span class="Operators">?</span>

    kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">error</span>
    <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\s+</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>  <span class="Comment"># in every state</span>
      kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">space</span>
      <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@regexp_allowed</span> <span class="Keywords">or</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Operators">.</span>index<span class="Pars">(</span><span class="Operators">?</span><span class="Operators">\</span>n<span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">def_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: (?:</span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::))* | (?:@@?|$)? </span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::) ) </span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
      <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">module_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
      <span class="Keywords">else</span>
        <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> (?:\.|::))* </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Keywords">else</span>
          <span class="Dico">@scanner</span><span class="Operators">.</span>getch
        <span class="Keywords">end</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">end</span>

    <span class="Keywords">elsif</span> <span class="Comment"># state == :initial</span>
      <span class="Comment"># IDENTIFIERS, KEYWORDS</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">GLOBAL_VARIABLE</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">global_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @@ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">class_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">instance_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> __END__\n ( (?!\#CODE\#) .* )? | \#[^\n]* | =begin(?=\s).*? \n=end(?=\s|\z)(?:[^\n]*)? </span><span class="Regex">/</span><span class="RegexOptions">mx</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">comment</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">METHOD_NAME</span><span class="Pars">)</span>
        <span class="Keywords">if</span> <span class="Dico">@last_token_dot</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span>
        <span class="Keywords">else</span>
          matched <span class="Operators">=</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched
          kind <span class="Operators">=</span> <span class="Special">IDENT_KIND</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span> <span class="Keywords">and</span> matched <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">^[A-Z]</span><span class="Regex">/</span><span class="RegexOptions"></span>
            kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">constant</span>
          <span class="Keywords">elsif</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">reserved</span>
            <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Special">DEF_NEW_STATE</span><span class="Pars">[</span>matched<span class="Pars">]</span>
            <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Special">REGEXP_ALLOWED</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">end</span>
        <span class="Keywords">end</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">STRING</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">SHELL</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">shell</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;
</span><span class="Regex">        (?:
</span><span class="Regex">          ([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\1$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          -([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\s*\2$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          ([&quot;\'`]) (.+?) \3
</span><span class="Regex">            (?: .*? ^\4$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          - ([&quot;\'`]) (.+?) \5
</span><span class="Regex">            (?: .*? ^\s*\6$ | .* )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mxo</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\/</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span> <span class="Keywords">and</span> <span class="Dico">@regexp_allowed</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>unscan
        <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">REGEXP</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
<span class="Regex">/</span><span class="Regex">%(?:[Qqxrw](?:\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\\\\])(?:(?!\1)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\1)[^#\\\\])*)*\1?)|\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\s\\\\])(?:(?!\2)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\2)[^#\\\\])*)*\2?|\\\\[^#\\\\]*(?:(?:#\{.*?\}|#)[^#\\\\]*)*\\\\?)</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">:(?:</span><span class="Entities">#{GLOBAL_VARIABLE}</span><span class="Regex">|</span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex">|</span><span class="Entities">#{STRING}</span><span class="Regex">)</span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">symbol</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">
</span><span class="Regex">        \? (?:
</span><span class="Regex">          [^\s\\]
</span><span class="Regex">        |
</span><span class="Regex">          \\ (?:M-\\C-|C-\\M-|M-\\c|c\\M-|c|C-|M-))? (?: \\ (?: . | [0-7]{3} | x[0-9A-Fa-f][0-9A-Fa-f] )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> [-+*\/%=&lt;&gt;;,|&amp;!()\[\]{}~?] | \.\.?\.? | ::? </span><span class="Regex">/</span><span class="RegexOptions">x</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
        <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">[</span><span class="Operators">-</span><span class="Special">1</span><span class="Pars">,</span><span class="Special">1</span><span class="Pars">]</span> <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">[~=!&lt;&gt;|&amp;^,\(\[+\-\/\*%]\z</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">FLOAT</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">float</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">INTEGER</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
    <span class="Keywords">end</span>

    token <span class="Operators">=</span> Token<span class="Operators">.</span><span class="Keywords">new</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">,</span> kind

    <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
      token<span class="Operators">.</span>text <span class="Operators">&lt;</span><span class="Operators">&lt;</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">[eimnosux]*</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
    <span class="Keywords">end</span>

    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Pars">(</span><span class="Dico">@regexp_allowed</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    token
  <span class="Keywords">end</span>
<span class="Keywords">end</span>

register Ruby<span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ruby</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rb</span><span class="SingleString">'</span>

  <span class="Keywords">end</span>
<span class="Keywords">end</span>
<span class="Entities4">module</span> <span class="className">CodeRay</span>
  <span class="Entities4">module</span> <span class="className">Scanners</span>

<span class="Entities3">class</span> <span class="className">Ruby</span> <span class="Operators">&lt;</span> <span class="className">S</span>canner

  <span class="Special">RESERVED_WORDS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">end</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">in</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">begin</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">defined?</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ensure</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">redo</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">super</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">BEGIN</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">break</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">do</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">next</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rescue</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">then</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">END</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">case</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">else</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">for</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">retry</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">alias</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">return</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">undef</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">yield</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">DEF_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">MODULE_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">DEF_NEW_STATE</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">initial</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">DEF_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">def_expected</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">MODULE_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">module_expected</span><span class="Pars">)</span>

  <span class="Special">WORDS_ALLOWING_REGEXP</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span>
  <span class="Pars">]</span>
  <span class="Special">REGEXP_ALLOWED</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Logic">false</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">WORDS_ALLOWING_REGEXP</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>

  <span class="Special">PREDEFINED_CONSTANTS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">nil</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">true</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">false</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">self</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">DATA</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGV</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGF</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__FILE__</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__LINE__</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">IDENT_KIND</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">ident</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">RESERVED_WORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">reserved</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">PREDEFINED_CONSTANTS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">pre_constant</span><span class="Pars">)</span>

  <span class="Special">METHOD_NAME</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{IDENT}</span><span class="Regex"> [?!]? </span><span class="Regex">/</span><span class="RegexOptions">xo</span>
  <span class="Special">METHOD_NAME_EX</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">
</span><span class="Regex">   </span><span class="Entities">#{METHOD_NAME}</span><span class="Regex">  # common methods: split, foo=, empty?, gsub!
</span><span class="Regex">   | \*\*?         # multiplication and power
</span><span class="Regex">   | [-+~]@?       # plus, minus
</span><span class="Regex">   | [\/%&amp;|^`]     # division, modulo or format strings, &amp;and, |or, ^xor, `system`
</span><span class="Regex">   | \[\]=?        # array getter and setter
</span><span class="Regex">   | &lt;=?&gt;? | &gt;=?   # comparison, rocket operator
</span><span class="Regex">   | &lt;&lt; | &gt;&gt;       # append or shift left, shift right
</span><span class="Regex">   | ===?          # simple equality and case equality
</span><span class="Regex">  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">GLOBAL_VARIABLE</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \$ (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> | \d+ | [~&amp;+`'=\/,;_.&lt;&gt;!@0$?*&quot;:F\\] | -[a-zA-Z_0-9] ) </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DOUBLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> &quot;  [^&quot;\#\\]*  (?: (?: \#\{.*?\} | \#(?:$&quot;)?  | \\. ) [^&quot;\#\\]*  )* &quot;?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SINGLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> '  [^'\\]*    (?:                              \\.   [^'\\]*    )* '?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">STRING</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{SINGLEQ}</span><span class="Regex"> | </span><span class="Entities">#{DOUBLEQ}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SHELL</span>   <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> `  [^`\#\\]*  (?: (?: \#\{.*?\} | \#(?:$`)?  | \\. ) [^`\#\\]*  )* `?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">REGEXP</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \/ [^\/\#\\]* (?: (?: \#\{.*?\} | \#(?:$\/)? | \\. ) [^\/\#\\]* )* \/? </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">\d+(?:_\d+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>  <span class="Comment"># doesn't recognize 09 as octal error</span>
  <span class="Special">OCTAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0_?[0-7]+(?:_[0-7]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">HEXADECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0x[0-9A-Fa-f]+(?:_[0-9A-Fa-f]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">BINARY</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0b[01]+(?:_[01]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Special">EXPONENT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> [eE] [+-]? </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">FLOAT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> (?: </span><span class="Entities">#{EXPONENT}</span><span class="Regex"> | \. </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Entities">#{EXPONENT}</span><span class="Regex">? ) </span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">INTEGER</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Entities">#{OCTAL}</span><span class="Regex">|</span><span class="Entities">#{HEXADECIMAL}</span><span class="Regex">|</span><span class="Entities">#{BINARY}</span><span class="Regex">|</span><span class="Entities">#{DECIMAL}</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Entities2">def</span> <span class="funcName">reset</span>
    <span class="Keywords">super</span>
    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Logic">false</span>
  <span class="Keywords">end</span>

  <span class="Entities2">def</span> <span class="funcName">next_token</span>
    <span class="Keywords">return</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>eos<span class="Operators">?</span>

    kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">error</span>
    <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\s+</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>  <span class="Comment"># in every state</span>
      kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">space</span>
      <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@regexp_allowed</span> <span class="Keywords">or</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Operators">.</span>index<span class="Pars">(</span><span class="Operators">?</span><span class="Operators">\</span>n<span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">def_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: (?:</span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::))* | (?:@@?|$)? </span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::) ) </span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
      <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">module_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
      <span class="Keywords">else</span>
        <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> (?:\.|::))* </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Keywords">else</span>
          <span class="Dico">@scanner</span><span class="Operators">.</span>getch
        <span class="Keywords">end</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">end</span>

    <span class="Keywords">elsif</span> <span class="Comment"># state == :initial</span>
      <span class="Comment"># IDENTIFIERS, KEYWORDS</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">GLOBAL_VARIABLE</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">global_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @@ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">class_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">instance_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> __END__\n ( (?!\#CODE\#) .* )? | \#[^\n]* | =begin(?=\s).*? \n=end(?=\s|\z)(?:[^\n]*)? </span><span class="Regex">/</span><span class="RegexOptions">mx</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">comment</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">METHOD_NAME</span><span class="Pars">)</span>
        <span class="Keywords">if</span> <span class="Dico">@last_token_dot</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span>
        <span class="Keywords">else</span>
          matched <span class="Operators">=</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched
          kind <span class="Operators">=</span> <span class="Special">IDENT_KIND</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span> <span class="Keywords">and</span> matched <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">^[A-Z]</span><span class="Regex">/</span><span class="RegexOptions"></span>
            kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">constant</span>
          <span class="Keywords">elsif</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">reserved</span>
            <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Special">DEF_NEW_STATE</span><span class="Pars">[</span>matched<span class="Pars">]</span>
            <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Special">REGEXP_ALLOWED</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">end</span>
        <span class="Keywords">end</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">STRING</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">SHELL</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">shell</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;
</span><span class="Regex">        (?:
</span><span class="Regex">          ([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\1$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          -([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\s*\2$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          ([&quot;\'`]) (.+?) \3
</span><span class="Regex">            (?: .*? ^\4$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          - ([&quot;\'`]) (.+?) \5
</span><span class="Regex">            (?: .*? ^\s*\6$ | .* )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mxo</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\/</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span> <span class="Keywords">and</span> <span class="Dico">@regexp_allowed</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>unscan
        <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">REGEXP</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
<span class="Regex">/</span><span class="Regex">%(?:[Qqxrw](?:\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\\\\])(?:(?!\1)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\1)[^#\\\\])*)*\1?)|\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\s\\\\])(?:(?!\2)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\2)[^#\\\\])*)*\2?|\\\\[^#\\\\]*(?:(?:#\{.*?\}|#)[^#\\\\]*)*\\\\?)</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">:(?:</span><span class="Entities">#{GLOBAL_VARIABLE}</span><span class="Regex">|</span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex">|</span><span class="Entities">#{STRING}</span><span class="Regex">)</span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">symbol</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">
</span><span class="Regex">        \? (?:
</span><span class="Regex">          [^\s\\]
</span><span class="Regex">        |
</span><span class="Regex">          \\ (?:M-\\C-|C-\\M-|M-\\c|c\\M-|c|C-|M-))? (?: \\ (?: . | [0-7]{3} | x[0-9A-Fa-f][0-9A-Fa-f] )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> [-+*\/%=&lt;&gt;;,|&amp;!()\[\]{}~?] | \.\.?\.? | ::? </span><span class="Regex">/</span><span class="RegexOptions">x</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
        <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">[</span><span class="Operators">-</span><span class="Special">1</span><span class="Pars">,</span><span class="Special">1</span><span class="Pars">]</span> <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">[~=!&lt;&gt;|&amp;^,\(\[+\-\/\*%]\z</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">FLOAT</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">float</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">INTEGER</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
    <span class="Keywords">end</span>

    token <span class="Operators">=</span> Token<span class="Operators">.</span><span class="Keywords">new</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">,</span> kind

    <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
      token<span class="Operators">.</span>text <span class="Operators">&lt;</span><span class="Operators">&lt;</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">[eimnosux]*</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
    <span class="Keywords">end</span>

    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Pars">(</span><span class="Dico">@regexp_allowed</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    token
  <span class="Keywords">end</span>
<span class="Keywords">end</span>

register Ruby<span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ruby</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rb</span><span class="SingleString">'</span>

  <span class="Keywords">end</span>
<span class="Keywords">end</span>
<span class="Entities4">module</span> <span class="className">CodeRay</span>
  <span class="Entities4">module</span> <span class="className">Scanners</span>

<span class="Entities3">class</span> <span class="className">Ruby</span> <span class="Operators">&lt;</span> <span class="className">S</span>canner

  <span class="Special">RESERVED_WORDS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">end</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">in</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">begin</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">defined?</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ensure</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">redo</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">super</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">BEGIN</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">break</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">do</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">next</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rescue</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">then</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">END</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">case</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">else</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">for</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">retry</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">alias</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">return</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">undef</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">yield</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">DEF_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">MODULE_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">DEF_NEW_STATE</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">initial</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">DEF_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">def_expected</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">MODULE_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">module_expected</span><span class="Pars">)</span>

  <span class="Special">WORDS_ALLOWING_REGEXP</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span>
  <span class="Pars">]</span>
  <span class="Special">REGEXP_ALLOWED</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Logic">false</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">WORDS_ALLOWING_REGEXP</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>

  <span class="Special">PREDEFINED_CONSTANTS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">nil</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">true</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">false</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">self</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">DATA</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGV</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGF</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__FILE__</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__LINE__</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">IDENT_KIND</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">ident</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">RESERVED_WORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">reserved</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">PREDEFINED_CONSTANTS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">pre_constant</span><span class="Pars">)</span>

  <span class="Special">METHOD_NAME</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{IDENT}</span><span class="Regex"> [?!]? </span><span class="Regex">/</span><span class="RegexOptions">xo</span>
  <span class="Special">METHOD_NAME_EX</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">
</span><span class="Regex">   </span><span class="Entities">#{METHOD_NAME}</span><span class="Regex">  # common methods: split, foo=, empty?, gsub!
</span><span class="Regex">   | \*\*?         # multiplication and power
</span><span class="Regex">   | [-+~]@?       # plus, minus
</span><span class="Regex">   | [\/%&amp;|^`]     # division, modulo or format strings, &amp;and, |or, ^xor, `system`
</span><span class="Regex">   | \[\]=?        # array getter and setter
</span><span class="Regex">   | &lt;=?&gt;? | &gt;=?   # comparison, rocket operator
</span><span class="Regex">   | &lt;&lt; | &gt;&gt;       # append or shift left, shift right
</span><span class="Regex">   | ===?          # simple equality and case equality
</span><span class="Regex">  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">GLOBAL_VARIABLE</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \$ (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> | \d+ | [~&amp;+`'=\/,;_.&lt;&gt;!@0$?*&quot;:F\\] | -[a-zA-Z_0-9] ) </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DOUBLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> &quot;  [^&quot;\#\\]*  (?: (?: \#\{.*?\} | \#(?:$&quot;)?  | \\. ) [^&quot;\#\\]*  )* &quot;?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SINGLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> '  [^'\\]*    (?:                              \\.   [^'\\]*    )* '?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">STRING</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{SINGLEQ}</span><span class="Regex"> | </span><span class="Entities">#{DOUBLEQ}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SHELL</span>   <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> `  [^`\#\\]*  (?: (?: \#\{.*?\} | \#(?:$`)?  | \\. ) [^`\#\\]*  )* `?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">REGEXP</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \/ [^\/\#\\]* (?: (?: \#\{.*?\} | \#(?:$\/)? | \\. ) [^\/\#\\]* )* \/? </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">\d+(?:_\d+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>  <span class="Comment"># doesn't recognize 09 as octal error</span>
  <span class="Special">OCTAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0_?[0-7]+(?:_[0-7]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">HEXADECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0x[0-9A-Fa-f]+(?:_[0-9A-Fa-f]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">BINARY</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0b[01]+(?:_[01]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Special">EXPONENT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> [eE] [+-]? </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">FLOAT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> (?: </span><span class="Entities">#{EXPONENT}</span><span class="Regex"> | \. </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Entities">#{EXPONENT}</span><span class="Regex">? ) </span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">INTEGER</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Entities">#{OCTAL}</span><span class="Regex">|</span><span class="Entities">#{HEXADECIMAL}</span><span class="Regex">|</span><span class="Entities">#{BINARY}</span><span class="Regex">|</span><span class="Entities">#{DECIMAL}</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Entities2">def</span> <span class="funcName">reset</span>
    <span class="Keywords">super</span>
    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Logic">false</span>
  <span class="Keywords">end</span>

  <span class="Entities2">def</span> <span class="funcName">next_token</span>
    <span class="Keywords">return</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>eos<span class="Operators">?</span>

    kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">error</span>
    <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\s+</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>  <span class="Comment"># in every state</span>
      kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">space</span>
      <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@regexp_allowed</span> <span class="Keywords">or</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Operators">.</span>index<span class="Pars">(</span><span class="Operators">?</span><span class="Operators">\</span>n<span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">def_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: (?:</span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::))* | (?:@@?|$)? </span><span class="Entities">#{IDENT}</span><span class="Regex">(?:\.|::) ) </span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
      <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>

    <span class="Keywords">elsif</span> <span class="Dico">@state</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">module_expected</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
      <span class="Keywords">else</span>
        <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> (?:\.|::))* </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">method</span>
        <span class="Keywords">else</span>
          <span class="Dico">@scanner</span><span class="Operators">.</span>getch
        <span class="Keywords">end</span>
        <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">initial</span>
      <span class="Keywords">end</span>

    <span class="Keywords">elsif</span> <span class="Comment"># state == :initial</span>
      <span class="Comment"># IDENTIFIERS, KEYWORDS</span>
      <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">GLOBAL_VARIABLE</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">global_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @@ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">class_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> @ </span><span class="Entities">#{IDENT}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">instance_variable</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> __END__\n ( (?!\#CODE\#) .* )? | \#[^\n]* | =begin(?=\s).*? \n=end(?=\s|\z)(?:[^\n]*)? </span><span class="Regex">/</span><span class="RegexOptions">mx</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">comment</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">METHOD_NAME</span><span class="Pars">)</span>
        <span class="Keywords">if</span> <span class="Dico">@last_token_dot</span>
          kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span>
        <span class="Keywords">else</span>
          matched <span class="Operators">=</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched
          kind <span class="Operators">=</span> <span class="Special">IDENT_KIND</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">ident</span> <span class="Keywords">and</span> matched <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">^[A-Z]</span><span class="Regex">/</span><span class="RegexOptions"></span>
            kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">constant</span>
          <span class="Keywords">elsif</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">reserved</span>
            <span class="Dico">@state</span> <span class="Operators">=</span> <span class="Special">DEF_NEW_STATE</span><span class="Pars">[</span>matched<span class="Pars">]</span>
            <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Special">REGEXP_ALLOWED</span><span class="Pars">[</span>matched<span class="Pars">]</span>
          <span class="Keywords">end</span>
        <span class="Keywords">end</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">STRING</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">SHELL</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">shell</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">&lt;&lt;
</span><span class="Regex">        (?:
</span><span class="Regex">          ([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\1$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          -([a-zA-Z_0-9]+)
</span><span class="Regex">            (?: .*? ^\s*\2$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          ([&quot;\'`]) (.+?) \3
</span><span class="Regex">            (?: .*? ^\4$ | .* )
</span><span class="Regex">        |
</span><span class="Regex">          - ([&quot;\'`]) (.+?) \5
</span><span class="Regex">            (?: .*? ^\s*\6$ | .* )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mxo</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">string</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">\/</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span> <span class="Keywords">and</span> <span class="Dico">@regexp_allowed</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>unscan
        <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">REGEXP</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
<span class="Regex">/</span><span class="Regex">%(?:[Qqxrw](?:\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\\\\])(?:(?!\1)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\1)[^#\\\\])*)*\1?)|\([^)#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^)#\\\\]*)*\)?|\[[^\]#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^\]#\\\\]*)*\]?|\{[^}#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^}#\\\\]*)*\}?|&lt;[^&gt;#\\\\]*(?:(?:#\{.*?\}|#|\\\\.)[^&gt;#\\\\]*)*&gt;?|([^a-zA-Z\s\\\\])(?:(?!\2)[^#\\\\])*(?:(?:#\{.*?\}|#|\\\\.)(?:(?!\2)[^#\\\\])*)*\2?|\\\\[^#\\\\]*(?:(?:#\{.*?\}|#)[^#\\\\]*)*\\\\?)</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">:(?:</span><span class="Entities">#{GLOBAL_VARIABLE}</span><span class="Regex">|</span><span class="Entities">#{METHOD_NAME_EX}</span><span class="Regex">|</span><span class="Entities">#{STRING}</span><span class="Regex">)</span><span class="Regex">/</span><span class="RegexOptions">ox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">symbol</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">
</span><span class="Regex">        \? (?:
</span><span class="Regex">          [^\s\\]
</span><span class="Regex">        |
</span><span class="Regex">          \\ (?:M-\\C-|C-\\M-|M-\\c|c\\M-|c|C-|M-))? (?: \\ (?: . | [0-7]{3} | x[0-9A-Fa-f][0-9A-Fa-f] )
</span><span class="Regex">        )
</span><span class="Regex">      </span><span class="Regex">/</span><span class="RegexOptions">mox</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>

      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex"> [-+*\/%=&lt;&gt;;,|&amp;!()\[\]{}~?] | \.\.?\.? | ::? </span><span class="Regex">/</span><span class="RegexOptions">x</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">operator</span>
        <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span> <span class="Keywords">if</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">[</span><span class="Operators">-</span><span class="Special">1</span><span class="Pars">,</span><span class="Special">1</span><span class="Pars">]</span> <span class="Operators">=</span>~ <span class="Regex">/</span><span class="Regex">[~=!&lt;&gt;|&amp;^,\(\[+\-\/\*%]\z</span><span class="Regex">/</span><span class="RegexOptions"></span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">FLOAT</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">float</span>
      <span class="Keywords">elsif</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Special">INTEGER</span><span class="Pars">)</span>
        kind <span class="Operators">=</span> <span class="Operators">:</span><span class="Types">integer</span>
      <span class="Keywords">else</span>
        <span class="Dico">@scanner</span><span class="Operators">.</span>getch
      <span class="Keywords">end</span>
    <span class="Keywords">end</span>

    token <span class="Operators">=</span> Token<span class="Operators">.</span><span class="Keywords">new</span> <span class="Dico">@scanner</span><span class="Operators">.</span>matched<span class="Pars">,</span> kind

    <span class="Keywords">if</span> kind <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">regexp</span>
      token<span class="Operators">.</span>text <span class="Operators">&lt;</span><span class="Operators">&lt;</span> <span class="Dico">@scanner</span><span class="Operators">.</span>scan<span class="Pars">(</span><span class="Regex">/</span><span class="Regex">[eimnosux]*</span><span class="Regex">/</span><span class="RegexOptions"></span><span class="Pars">)</span>
    <span class="Keywords">end</span>

    <span class="Dico">@regexp_allowed</span> <span class="Operators">=</span> <span class="Pars">(</span><span class="Dico">@regexp_allowed</span> <span class="Operators">=</span><span class="Operators">=</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>  <span class="Comment"># delayed flag setting</span>

    token
  <span class="Keywords">end</span>
<span class="Keywords">end</span>

register Ruby<span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ruby</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rb</span><span class="SingleString">'</span>

  <span class="Keywords">end</span>
<span class="Keywords">end</span>
<span class="Entities4">module</span> <span class="className">CodeRay</span>
  <span class="Entities4">module</span> <span class="className">Scanners</span>

<span class="Entities3">class</span> <span class="className">Ruby</span> <span class="Operators">&lt;</span> <span class="className">S</span>canner

  <span class="Special">RESERVED_WORDS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">end</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">in</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">begin</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">defined?</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ensure</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">redo</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">super</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">BEGIN</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">break</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">do</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">next</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">rescue</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">then</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">END</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">case</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">else</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">for</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">retry</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">alias</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">return</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">undef</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">yield</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">DEF_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">def</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">MODULE_KEYWORDS</span> <span class="Operators">=</span> <span class="Pars">[</span><span class="SingleString">'</span><span class="SingleString">class</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">module</span><span class="SingleString">'</span><span class="Pars">]</span>
  <span class="Special">DEF_NEW_STATE</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">initial</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">DEF_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">def_expected</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">MODULE_KEYWORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">module_expected</span><span class="Pars">)</span>

  <span class="Special">WORDS_ALLOWING_REGEXP</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">and</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">or</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">not</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">while</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">until</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">unless</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">if</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">elsif</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">when</span><span class="SingleString">'</span>
  <span class="Pars">]</span>
  <span class="Special">REGEXP_ALLOWED</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Logic">false</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">WORDS_ALLOWING_REGEXP</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">set</span><span class="Pars">)</span>

  <span class="Special">PREDEFINED_CONSTANTS</span> <span class="Operators">=</span> <span class="Pars">[</span>
    <span class="SingleString">'</span><span class="SingleString">nil</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">true</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">false</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">self</span><span class="SingleString">'</span><span class="Pars">,</span>
    <span class="SingleString">'</span><span class="SingleString">DATA</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGV</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">ARGF</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__FILE__</span><span class="SingleString">'</span><span class="Pars">,</span> <span class="SingleString">'</span><span class="SingleString">__LINE__</span><span class="SingleString">'</span><span class="Pars">,</span>
  <span class="Pars">]</span>

  <span class="Special">IDENT_KIND</span> <span class="Operators">=</span> WordList<span class="Operators">.</span><span class="Keywords">new</span><span class="Pars">(</span><span class="Operators">:</span><span class="Types">ident</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">RESERVED_WORDS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">reserved</span><span class="Pars">)</span><span class="Operators">.</span>
    add<span class="Pars">(</span><span class="Special">PREDEFINED_CONSTANTS</span><span class="Pars">,</span> <span class="Operators">:</span><span class="Types">pre_constant</span><span class="Pars">)</span>

  <span class="Special">METHOD_NAME</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{IDENT}</span><span class="Regex"> [?!]? </span><span class="Regex">/</span><span class="RegexOptions">xo</span>
  <span class="Special">METHOD_NAME_EX</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">
</span><span class="Regex">   </span><span class="Entities">#{METHOD_NAME}</span><span class="Regex">  # common methods: split, foo=, empty?, gsub!
</span><span class="Regex">   | \*\*?         # multiplication and power
</span><span class="Regex">   | [-+~]@?       # plus, minus
</span><span class="Regex">   | [\/%&amp;|^`]     # division, modulo or format strings, &amp;and, |or, ^xor, `system`
</span><span class="Regex">   | \[\]=?        # array getter and setter
</span><span class="Regex">   | &lt;=?&gt;? | &gt;=?   # comparison, rocket operator
</span><span class="Regex">   | &lt;&lt; | &gt;&gt;       # append or shift left, shift right
</span><span class="Regex">   | ===?          # simple equality and case equality
</span><span class="Regex">  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">GLOBAL_VARIABLE</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \$ (?: </span><span class="Entities">#{IDENT}</span><span class="Regex"> | \d+ | [~&amp;+`'=\/,;_.&lt;&gt;!@0$?*&quot;:F\\] | -[a-zA-Z_0-9] ) </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DOUBLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> &quot;  [^&quot;\#\\]*  (?: (?: \#\{.*?\} | \#(?:$&quot;)?  | \\. ) [^&quot;\#\\]*  )* &quot;?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SINGLEQ</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> '  [^'\\]*    (?:                              \\.   [^'\\]*    )* '?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">STRING</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{SINGLEQ}</span><span class="Regex"> | </span><span class="Entities">#{DOUBLEQ}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">SHELL</span>   <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> `  [^`\#\\]*  (?: (?: \#\{.*?\} | \#(?:$`)?  | \\. ) [^`\#\\]*  )* `?  </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">REGEXP</span>  <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> \/ [^\/\#\\]* (?: (?: \#\{.*?\} | \#(?:$\/)? | \\. ) [^\/\#\\]* )* \/? </span><span class="Regex">/</span><span class="RegexOptions">ox</span>

  <span class="Special">DECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">\d+(?:_\d+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>  <span class="Comment"># doesn't recognize 09 as octal error</span>
  <span class="Special">OCTAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0_?[0-7]+(?:_[0-7]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">HEXADECIMAL</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0x[0-9A-Fa-f]+(?:_[0-9A-Fa-f]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>
  <span class="Special">BINARY</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex">0b[01]+(?:_[01]+)*</span><span class="Regex">/</span><span class="RegexOptions"></span>

  <span class="Special">EXPONENT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> [eE] [+-]? </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Regex">/</span><span class="RegexOptions">ox</span>
  <span class="Special">FLOAT</span> <span class="Operators">=</span> <span class="Regex">/</span><span class="Regex"> </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> (?: </span><span class="Entities">#{EXPONENT}</span><span class="Regex"> | \. </span><span class="Entities">#{DECIMAL}</span><span class="Regex"> </span><span class="Entities">#{EXPONENT}</span><span class="Regex">? ) </span><span class="Regex">/</span><span class="RegexOptions"></span>
          </pre>
        </div>
   </body>
  </html>
